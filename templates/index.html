<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Car Plate & Pollution</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: sans-serif; background: #1a1a1a; color: #eee; padding: 20px; }
    h1 { text-align: center; margin-bottom: 10px; color: #22d3ee; }
    p.sub { text-align: center; color: #888; margin-bottom: 30px; }
    .row { display: flex; flex-wrap: wrap; gap: 20px; max-width: 900px; margin: 0 auto; }
    .card { background: #252525; border-radius: 10px; padding: 20px; flex: 1; min-width: 280px; }
    .card h2 { color: #22d3ee; margin-bottom: 15px; font-size: 1.1rem; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 1rem; font-weight: 600; }
    .btn.primary { background: #22d3ee; color: #111; }
    .btn.secondary { background: #333; color: #22d3ee; border: 1px solid #444; }
    .btn:hover { opacity: 0.9; }
    #cameraBox { display: none; margin-top: 15px; }
    #cameraBox.show { display: block; }
    #cameraBox img { width: 100%; max-height: 320px; border-radius: 8px; background: #111; }
    input { width: 100%; padding: 10px; margin: 8px 0; background: #333; border: 1px solid #444; border-radius: 8px; color: #eee; font-size: 1rem; }
    #result { display: none; margin-top: 15px; }
    #result.show { display: block; }
    .stat { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #333; }
    .badge { margin-top: 12px; padding: 10px; border-radius: 8px; text-align: center; font-weight: 600; }
    .badge.high { background: #4a1515; color: #f88; }
    .badge.mid { background: #4a3a15; color: #fa8; }
    .badge.low { background: #154a2a; color: #8f8; }
    .err { color: #f66; margin-top: 10px; font-size: 0.9rem; display: none; }
    .err.show { display: block; }
    .hint { color: #666; font-size: 0.85rem; margin-top: 5px; }
  </style>
</head>
<body>
  <h1>Car Plate Detection & Pollution</h1>
  <p class="sub">Open camera for plate detection • Enter plate for pollution data</p>

  <div class="row">
    <div class="card">
      <h2>Plate Detection</h2>
      <button class="btn primary" id="openBtn">Open Camera</button>
      <button class="btn secondary" id="closeBtn" style="display:none">Close Camera</button>
      <div id="cameraBox">
        <img id="cameraImg" src="" alt="Camera">
      </div>
      <p class="hint">Plates show in green when detected.</p>
      <p class="err" id="camErr"></p>
    </div>

    <div class="card">
      <h2>Pollution Lookup</h2>
      <form id="form">
        <input type="text" id="plate" placeholder="e.g. MH12AB1234">
        <p class="hint">Try: MH12AB1234, DL9CG4545, KA05AB6789</p>
        <button type="submit" class="btn primary" style="width:100%; margin-top:10px">Lookup</button>
      </form>
      <div id="result">
        <div class="stat"><span>CO₂</span><span id="co2"></span></div>
        <div class="stat"><span>NOx</span><span id="nox"></span></div>
        <div class="stat"><span>PM2.5</span><span id="pm25"></span></div>
        <div class="badge" id="badge"></div>
      </div>
      <p class="err" id="pollErr"></p>
    </div>
  </div>

  <script>
    // Camera
    var openBtn = document.getElementById('openBtn');
    var closeBtn = document.getElementById('closeBtn');
    var cameraBox = document.getElementById('cameraBox');
    var cameraImg = document.getElementById('cameraImg');
    var camErr = document.getElementById('camErr');

    openBtn.onclick = function() {
      camErr.classList.remove('show');
      cameraImg.src = '/video_feed';
      cameraBox.classList.add('show');
      openBtn.style.display = 'none';
      closeBtn.style.display = 'inline-block';
    };

    closeBtn.onclick = function() {
      fetch('/api/camera/stop', { method: 'POST' }).catch(function(){});
      cameraImg.src = '';
      cameraBox.classList.remove('show');
      openBtn.style.display = 'inline-block';
      closeBtn.style.display = 'none';
    };

    // Pollution
    var form = document.getElementById('form');
    var plate = document.getElementById('plate');
    var result = document.getElementById('result');
    var pollErr = document.getElementById('pollErr');

    form.onsubmit = function(e) {
      e.preventDefault();
      var p = plate.value.trim();
      if (!p) {
        pollErr.textContent = 'Enter plate number';
        pollErr.classList.add('show');
        result.classList.remove('show');
        return;
      }
      pollErr.classList.remove('show');
      result.classList.remove('show');
      fetch('/api/pollution/' + encodeURIComponent(p))
        .then(function(r) { return r.json(); })
        .then(function(data) {
          if (!data.ok) {
            pollErr.textContent = data.error || 'Error';
            pollErr.classList.add('show');
            return;
          }
          var v = data.vehicle;
          document.getElementById('co2').textContent = v.co2_emission + ' g/km';
          document.getElementById('nox').textContent = v.nox_emission + ' g/km';
          document.getElementById('pm25').textContent = v.pm25_level + ' µg/m³';
          var badge = document.getElementById('badge');
          badge.textContent = v.classification;
          badge.className = 'badge ' + (v.classification.indexOf('High') >= 0 ? 'high' : v.classification.indexOf('Moderate') >= 0 ? 'mid' : 'low');
          result.classList.add('show');
        })
        .catch(function() {
          pollErr.textContent = 'Network error';
          pollErr.classList.add('show');
        });
    };
  </script>
</body>
</html>
